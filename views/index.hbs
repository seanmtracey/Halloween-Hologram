<video autoplay src=""></video>

<script>

    (async function(){

        'use strict';


        // Video player variables
        const videos = [
            "1_edit.mp4",
            "2.mp4",
            "3.mp4",
            "4.mp4",
            "5.mp4",
            "6.mp4",
            "7.mp4",
            "8.mp4",
            "9.mp4",
            "10.mp4",
            "11.mp4",
        ];

        const videoPlayer = document.body.querySelector('video');
        videoPlayer.src = `/videos/${videos[Math.random() * videos.length | 0 ]}`;

        // Posenet variables
        const net = await posenet.load()

        // getUserMedia variables
        const webcamVideo = document.createElement('video');
        const videoConstraints = { video: true };
        const canvas = document.createElement('canvas');

        let videoWidth;
        let videoHeight;
        let videoLastPlayed = 0;

        webcamVideo.setAttribute('autoplay', 'autoplay');

        function playSpookyVideo(){
            
            videoPlayer.currentTime = 0;
            videoPlayer.src = `/videos/${videos[Math.random() * videos.length | 0 ]}`;
            videoPlayer.play();
            videoLastPlayed = new Date() / 1000;

        }

        navigator.mediaDevices.getUserMedia(videoConstraints)
            .then(function(stream) {

                console.log(stream);
                videoWidth = stream.getVideoTracks()[0].getSettings().width;
                videoHeight = stream.getVideoTracks()[0].getSettings().height;

                console.log(videoWidth, videoHeight);

                canvas.width = videoWidth;
                canvas.height = videoHeight;

                {{!-- document.body.appendChild(webcamVideo); --}}

                try{
                    const vidURL = window.URL.createObjectURL(stream);
                    webcamVideo.src = vidURL;
                } catch(err){
                    console.log('Unable to createObjectURL for stream. Setting srcObject to stream instead...');
                    webcamVideo.srcObject = stream;
                }

            })
        ;

        setInterval(async function(){

            console.log('PING!');

            if(videoPlayer.paused){
                
                const pose = await net.estimateSinglePose(webcamVideo, {
                    flipHorizontal: false
                });
                console.log(pose);

                if(pose.score > 0.3){
                    
                    const now = new Date() / 1000;

                    if(now - videoLastPlayed > 30){
                        playSpookyVideo();
                    }

                }

            }



        }, 1500);

        window.addEventListener('keyup', function(e){
            console.log(e.keyCode);

            if(e.keyCode === 70){
                document.body.requestFullscreen();
            }

        }, false);


    }());

</script>